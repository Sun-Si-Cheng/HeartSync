name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
      - 'release/**'
  pull_request:
    branches:
      - main
      - develop

env:
  PYTHON_VERSION: '3.10'

jobs:
  # 代码质量检查
  lint:
    name: 代码质量检查
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
      
      - name: 设置Python环境
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: 安装依赖
        run: |
          pip install --upgrade pip
          pip install flake8 pylint mypy black isort
          pip install -r requirements.txt
      
      - name: 代码格式检查
        run: |
          black --check .
          isort --check-only .
      
      - name: 代码质量检查
        run: |
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
      
      - name: 类型检查
        run: |
          mypy app.py models.py forms.py --ignore-missing-imports || true

  # 安全检查
  security:
    name: 安全扫描
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
      
      - name: 设置Python环境
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: 安装依赖
        run: |
          pip install --upgrade pip
          pip install safety bandit
          pip install -r requirements.txt
      
      - name: 依赖安全检查
        run: safety check --full-report || true
      
      - name: 代码安全检查
        run: bandit -r . -f json -o bandit-report.json || true
      
      - name: 上传安全报告
        uses: actions/upload-artifact@v3
        with:
          name: security-report
          path: bandit-report.json
          retention-days: 30

  # 单元测试
  test:
    name: 单元测试
    runs-on: ubuntu-latest
    needs: [lint]
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: heartsync_test
          POSTGRES_PASSWORD: test_password
          POSTGRES_USER: test_user
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
      
      - name: 设置Python环境
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: 安装依赖
        run: |
          pip install --upgrade pip
          pip install pytest pytest-cov pytest-flask pytest-socketio
          pip install -r requirements.txt
      
      - name: 配置测试环境
        run: |
          export DATABASE_URL=postgresql://test_user:test_password@localhost:5432/heartsync_test
          echo "DATABASE_URL=$DATABASE_URL" >> $GITHUB_ENV
      
      - name: 运行测试
        run: |
          pytest tests/ -v --cov=. --cov-report=xml --cov-report=html --cov-report=term-missing
      
      - name: 上传测试覆盖率报告
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  # 构建和打包
  build:
    name: 构建和打包
    runs-on: ubuntu-latest
    needs: [test, security]
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
      
      - name: 设置Python环境
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: 安装依赖
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: 创建部署包
        run: |
          mkdir -p deploy/package
          rsync -av --exclude='.git' \
                    --exclude='__pycache__' \
                    --exclude='*.pyc' \
                    --exclude='tests' \
                    --exclude='.pytest_cache' \
                    --exclude='.coverage' \
                    --exclude='htmlcov' \
                    --exclude='deploy/package' \
                    . deploy/package/
          
          # 创建版本信息
          echo "BUILD_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)" > deploy/package/version.txt
          echo "GIT_COMMIT=${{ github.sha }}" >> deploy/package/version.txt
          echo "GIT_BRANCH=${{ github.ref_name }}" >> deploy/package/version.txt
          echo "VERSION=$(date -u +%Y.%m.%d)-${{ github.run_number }}" >> deploy/package/version.txt
      
      - name: 创建部署归档
        run: |
          cd deploy/package
          tar -czf ../heartsync-${{ github.run_number }}.tar.gz .
      
      - name: 上传部署包
        uses: actions/upload-artifact@v3
        with:
          name: deploy-package
          path: deploy/heartsync-${{ github.run_number }}.tar.gz
          retention-days: 30
      
      - name: 生成构建信息
        run: |
          cat > build-info.json << EOF
          {
            "build_number": "${{ github.run_number }}",
            "commit": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}",
            "build_time": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "triggered_by": "${{ github.actor }}",
            "artifacts": [
              {
                "name": "deploy-package",
                "path": "deploy/heartsync-${{ github.run_number }}.tar.gz"
              }
            ]
          }
          EOF
      
      - name: 上传构建信息
        uses: actions/upload-artifact@v3
        with:
          name: build-info
          path: build-info.json
          retention-days: 30

  # 部署到开发环境
  deploy-dev:
    name: 部署到开发环境
    runs-on: ubuntu-latest
    needs: [build]
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    environment:
      name: development
      url: http://dev.heartsync.example.com
    
    steps:
      - name: 下载部署包
        uses: actions/download-artifact@v3
        with:
          name: deploy-package
      
      - name: 配置SSH密钥
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEV_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.DEV_HOST }} >> ~/.ssh/known_hosts
      
      - name: 上传到服务器
        run: |
          scp -P ${{ secrets.DEV_SSH_PORT }} \
            heartsync-${{ github.run_number }}.tar.gz \
            ${{ secrets.DEV_USER }}@${{ secrets.DEV_HOST }}:/tmp/
      
      - name: 执行部署脚本
        run: |
          ssh -p ${{ secrets.DEV_SSH_PORT }} ${{ secrets.DEV_USER }}@${{ secrets.DEV_HOST }} << 'ENDSSH'
            set -e
            
            # 创建备份
            cd /var/www/heartsync
            if [ -d "current" ]; then
              BACKUP_NAME="backup_$(date +%Y%m%d_%H%M%S)"
              cp -r current "/var/backups/heartsync/$BACKUP_NAME"
              echo "备份创建: $BACKUP_NAME"
            fi
            
            # 解压新版本
            mkdir -p current_new
            tar -xzf /tmp/heartsync-${{ github.run_number }}.tar.gz -C current_new
            rm /tmp/heartsync-${{ github.run_number }}.tar.gz
            
            # 切换版本
            mv current current_old || true
            mv current_new current
            rm -rf current_old || true
            
            # 配置环境
            cd current
            cp /var/www/heartsync/.env.development .env
            
            # 安装依赖
            python3 -m venv venv
            source venv/bin/activate
            pip install --upgrade pip
            pip install -r requirements.txt
            
            # 数据库迁移
            export FLASK_APP=app.py
            python -c "from app import app, db; app.app_context().push(); db.create_all()"
            
            # 重启服务
            sudo systemctl restart heartsync
            sudo systemctl reload nginx
            
            echo "部署完成！"
          ENDSSH
      
      - name: 健康检查
        run: |
          sleep 10
          curl -f ${{ secrets.DEV_URL }}/health || exit 1

  # 部署到测试环境
  deploy-staging:
    name: 部署到测试环境
    runs-on: ubuntu-latest
    needs: [build]
    if: github.ref == 'refs/heads/main' && github.event_name == 'pull_request'
    environment:
      name: staging
      url: https://staging.heartsync.example.com
    
    steps:
      - name: 下载部署包
        uses: actions/download-artifact@v3
        with:
          name: deploy-package
      
      - name: 配置SSH密钥
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.STAGING_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.STAGING_HOST }} >> ~/.ssh/known_hosts
      
      - name: 上传并部署
        run: |
          scp -P ${{ secrets.STAGING_SSH_PORT }} \
            heartsync-${{ github.run_number }}.tar.gz \
            ${{ secrets.STAGING_USER }}@${{ secrets.STAGING_HOST }}:/tmp/
          
          ssh -p ${{ secrets.STAGING_SSH_PORT }} ${{ secrets.STAGING_USER }}@${{ secrets.STAGING_HOST }} << 'ENDSSH'
            set -e
            cd /var/www/heartsync
            
            # 创建备份
            BACKUP_NAME="backup_$(date +%Y%m%d_%H%M%S)"
            cp -r current "/var/backups/heartsync/$BACKUP_NAME"
            
            # 部署新版本
            mkdir -p current_new
            tar -xzf /tmp/heartsync-${{ github.run_number }}.tar.gz -C current_new
            mv current current_old || true
            mv current_new current
            rm -rf current_old
            
            # 配置并重启
            cd current
            cp /var/www/heartsync/.env.staging .env
            source venv/bin/activate
            pip install -r requirements.txt
            export FLASK_APP=app.py
            python -c "from app import app, db; app.app_context().push(); db.create_all()"
            sudo systemctl restart heartsync
            sudo systemctl reload nginx
          ENDSSH
      
      - name: 健康检查
        run: |
          sleep 15
          curl -f ${{ secrets.STAGING_URL }}/health || exit 1

  # 部署到生产环境（需要手动批准）
  deploy-prod:
    name: 部署到生产环境
    runs-on: ubuntu-latest
    needs: [build]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production
      url: https://heartsync.example.com
    
    steps:
      - name: 下载部署包
        uses: actions/download-artifact@v3
        with:
          name: deploy-package
      
      - name: 配置SSH密钥
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.PROD_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.PROD_HOST }} >> ~/.ssh/known_hosts
      
      - name: 创建完整备份
        run: |
          ssh -p ${{ secrets.PROD_SSH_PORT }} ${{ secrets.PROD_USER }}@${{ secrets.PROD_HOST }} << 'ENDSSH'
            set -e
            cd /var/www/heartsync
            BACKUP_NAME="full_backup_$(date +%Y%m%d_%H%M%S)"
            mkdir -p /var/backups/heartsync
            tar -czf "/var/backups/heartsync/${BACKUP_NAME}.tar.gz" -C current .
            echo "完整备份: ${BACKUP_NAME}"
          ENDSSH
      
      - name: 上传并部署
        run: |
          scp -P ${{ secrets.PROD_SSH_PORT }} \
            heartsync-${{ github.run_number }}.tar.gz \
            ${{ secrets.PROD_USER }}@${{ secrets.PROD_HOST }}:/tmp/
          
          ssh -p ${{ secrets.PROD_SSH_PORT }} ${{ secrets.PROD_USER }}@${{ secrets.PROD_HOST }} << 'ENDSSH'
            set -e
            cd /var/www/heartsync
            
            # 部署新版本
            mkdir -p current_new
            tar -xzf /tmp/heartsync-${{ github.run_number }}.tar.gz -C current_new
            
            # 配置
            cd current_new
            cp /var/www/heartsync/.env.production .env
            source venv/bin/activate
            pip install -r requirements.txt
            export FLASK_APP=app.py
            python -c "from app import app, db; app.app_context().push(); db.create_all()"
            
            # 切换版本
            cd ..
            mv current current_old
            mv current_new current
            rm -rf current_old
            
            # 重启服务
            sudo systemctl restart heartsync
            sudo systemctl reload nginx
          ENDSSH
      
      - name: 健康检查
        run: |
          for i in {1..10}; do
            sleep 5
            if curl -f ${{ secrets.PROD_URL }}/health; then
              echo "健康检查通过"
              exit 0
            fi
            echo "健康检查失败，重试中 ($i/10)..."
          done
          echo "健康检查失败，准备回滚"
          exit 1
      
      - name: 部署失败时回滚
        if: failure()
        run: |
          ssh -p ${{ secrets.PROD_SSH_PORT }} ${{ secrets.PROD_USER }}@${{ secrets.PROD_HOST }} << 'ENDSSH'
            set -e
            cd /var/www/heartsync
            mv current_old current
            sudo systemctl restart heartsync
            sudo systemctl reload nginx
            echo "已回滚到上一版本"
          ENDSSH
