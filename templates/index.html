{% extends "base.html" %}

{% block title %}çˆ±å¿ƒåä½œ - {{ room_code }}{% endblock %}

{% block extra_head %}
<style>
    .heart {
        animation: heartbeat 1.5s ease-in-out infinite;
    }
    
    .heart.red {
        animation: heartbeat-red 0.5s ease-in-out 3;
    }
    
    @keyframes heartbeat {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.1); }
    }
    
    @keyframes heartbeat-red {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.2); background-color: #ff4d4d; }
    }
    
    .confetti {
        position: fixed;
        width: 10px;
        height: 10px;
        background-color: #ff0000;
        animation: confetti-fall 3s ease-out forwards;
    }
    
    @keyframes confetti-fall {
        0% {
            transform: translateY(-100vh) rotate(0deg);
            opacity: 1;
        }
        100% {
            transform: translateY(100vh) rotate(720deg);
            opacity: 0;
        }
    }
    
    .love-card {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 40px;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        text-align: center;
        z-index: 1000;
        animation: card-appear 0.5s ease-out;
        max-width: 90%;
    }
    
    @keyframes card-appear {
        0% {
            opacity: 0;
            transform: translate(-50%, -50%) scale(0.5);
        }
        100% {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="collaboration-container">
    <!-- æˆ¿é—´ä¿¡æ¯ -->
    <div class="room-header">
        <div class="room-info">
            <span class="room-label">æˆ¿é—´å·</span>
            <span class="room-code">{{ room_code }}</span>
            <button class="btn btn-sm" onclick="shareRoom()">
                ğŸ”— åˆ†äº«
            </button>
        </div>
        <div class="room-status">
            <span class="status-dot {% if user2_username %}active{% endif %}"></span>
            <span class="status-text">
                {% if user2_username %}
                    å·²è¿æ¥
                {% else %}
                    ç­‰å¾…å¯¹æ–¹åŠ å…¥...
                {% endif %}
            </span>
        </div>
    </div>

    <!-- ç”¨æˆ·åŒºåŸŸ -->
    <div class="users-section">
        <!-- ç”¨æˆ·1 -->
        <div class="user-card user-card-1">
            <div class="user-avatar">
                <span class="avatar-text">{{ current_user.nickname|first }}</span>
            </div>
            <div class="user-info">
                <div class="user-name">{{ current_user.nickname }}</div>
                <div class="user-label">æˆ‘</div>
            </div>
        </div>

        <!-- è¿æ¥çº¿ -->
        <div class="connection-line">
            <div class="heart-icon-container">
                <div class="heart" id="mainHeart">â¤ï¸</div>
            </div>
        </div>

        <!-- ç”¨æˆ·2 -->
        <div class="user-card user-card-2">
            <div class="user-avatar">
                <span class="avatar-text" id="user2-avatar">?</span>
            </div>
            <div class="user-info">
                <div class="user-name" id="user2-name">
                    {% if user2_username %}
                        {{ user2_username }}
                    {% else %}
                        ç­‰å¾…å¯¹æ–¹...
                    {% endif %}
                </div>
                <div class="user-label">TA</div>
            </div>
        </div>
    </div>

    <!-- æŒ‡ä»¤è¾“å…¥åŒº -->
    <div class="commands-section">
        <div class="command-card command-card-1">
            <div class="command-header">
                <span class="command-label">æˆ‘çš„æŒ‡ä»¤</span>
                <span class="command-status" id="my-status"></span>
            </div>
            <input type="text" 
                   id="my-command" 
                   class="command-input"
                   placeholder="è¾“å…¥é…å¯¹æŒ‡ä»¤..."
                   autocomplete="off">
            <div class="command-hint">
                æç¤ºï¼š{{ preset_pairs|map(attribute('description')|join('ã€') }}
            </div>
        </div>

        <div class="command-card command-card-2">
            <div class="command-header">
                <span class="command-label">TAçš„æŒ‡ä»¤</span>
                <span class="command-status" id="other-status"></span>
            </div>
            <input type="text" 
                   id="other-command" 
                   class="command-input"
                   disabled
                   placeholder="ç­‰å¾…TAè¾“å…¥...">
            <div class="command-hint" id="other-hint">
                {% if user2_username %}
                    å¯¹æ–¹å·²åŠ å…¥æˆ¿é—´
                {% else %}
                    ç­‰å¾…å¯¹æ–¹åŠ å…¥...
                {% endif %}
            </div>
        </div>
    </div>

    <!-- é¢„è®¾æŒ‡ä»¤ -->
    <div class="preset-section">
        <div class="preset-title">é¢„è®¾é…å¯¹æŒ‡ä»¤ï¼š</div>
        <div class="preset-tags">
            {% for pair in preset_pairs %}
                <button class="preset-tag" onclick="selectPreset('{{ pair.pair[0] }}')">
                    {{ pair.description }}
                </button>
            {% endfor %}
        </div>
    </div>

    <!-- æ¶ˆæ¯æç¤º -->
    <div class="message-area" id="messageArea"></div>
</div>

<!-- çºªå¿µå¡æ¨¡æ€æ¡† -->
<div class="modal-overlay" id="loveModal" style="display: none;">
    <div class="love-card">
        <div class="love-icon">ğŸ’•</div>
        <h2>é…å¯¹æˆåŠŸï¼</h2>
        <p class="love-description">
            <span id="loveDescription"></span>
        </p>
        <p class="love-time" id="loveTime"></p>
        <p class="love-users">
            {{ current_user.nickname }} & <span id="loveUser2"></span>
        </p>
        <button class="btn btn-primary" onclick="closeLoveModal()">
            ç»§ç»­åä½œ
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const roomCode = '{{ room_code }}';
const currentUser = '{{ current_user.nickname }}';
const socket = io();
let userRole = null;
let otherUsername = null;
let lastCommand = '';

// è¿æ¥SocketIO
socket.on('connect', function() {
    console.log('Socket connected');
    // åŠ å…¥æˆ¿é—´
    socket.emit('join_room', {
        room_code: roomCode,
        username: currentUser
    });
});

// ç›‘å¬æˆ¿é—´ä¿¡æ¯
socket.on('room_info', function(data) {
    userRole = data.user_role;
    
    // æ›´æ–°TAçš„ä¿¡æ¯
    if (userRole === 'user1') {
        otherUsername = data.user2_username;
        updateOtherUser(otherUsername, data.user2_command);
    } else {
        otherUsername = data.user1_username;
        updateOtherUser(otherUsername, data.user1_command);
    }
    
    updateConnectionStatus(!!otherUsername);
    showMessage('å·²åŠ å…¥æˆ¿é—´ ' + roomCode, 'info');
});

// ç›‘å¬ç”¨æˆ·åŠ å…¥
socket.on('user_joined', function(data) {
    otherUsername = data.username;
    updateOtherUser(otherUsername, '');
    updateConnectionStatus(true);
    showMessage(data.username + ' åŠ å…¥äº†æˆ¿é—´', 'success');
    
    // æ’­æ”¾éŸ³æ•ˆ
    playNotificationSound();
});

// ç›‘å¬æŒ‡ä»¤æ›´æ–°
socket.on('command_updated', function(data) {
    if (data.user_role !== userRole) {
        // å¯¹æ–¹çš„æŒ‡ä»¤
        document.getElementById('other-command').value = data.command;
        document.getElementById('other-status').textContent = 'å·²è¾“å…¥';
        document.getElementById('other-status').className = 'command-status success';
        
        if (data.command) {
            showMessage('TAå·²è¾“å…¥æŒ‡ä»¤', 'info');
            playNotificationSound();
        }
    }
});

// ç›‘å¬åŒ¹é…æˆåŠŸ
socket.on('match_success', function(data) {
    showLoveModal(data);
    createConfetti();
    playSuccessSound();
});

// ç›‘å¬åŒ¹é…å¤±è´¥
socket.on('match_failed', function(data) {
    document.getElementById('mainHeart').classList.add('red');
    setTimeout(() => {
        document.getElementById('mainHeart').classList.remove('red');
    }, 1500);
    
    showMessage(data.message, 'error');
    shakeElement(document.getElementById('my-command'));
    shakeElement(document.getElementById('other-command'));
});

// è¾“å…¥æŒ‡ä»¤
document.getElementById('my-command').addEventListener('input', function() {
    const command = this.value.trim();
    
    if (command === lastCommand) return;
    lastCommand = command;
    
    // æ›´æ–°çŠ¶æ€
    const statusEl = document.getElementById('my-status');
    if (command) {
        statusEl.textContent = 'å·²è¾“å…¥';
        statusEl.className = 'command-status success';
    } else {
        statusEl.textContent = '';
        statusEl.className = 'command-status';
    }
    
    // å‘é€åˆ°æœåŠ¡å™¨
    if (command) {
        socket.emit('submit_command', {
            room_code: roomCode,
            command: command,
            user_role: userRole
        });
    }
});

// é€‰æ‹©é¢„è®¾æŒ‡ä»¤
function selectPreset(command) {
    const input = document.getElementById('my-command');
    input.value = command;
    input.focus();
    
    // è§¦å‘inputäº‹ä»¶
    input.dispatchEvent(new Event('input'));
}

// æ›´æ–°TAçš„ç”¨æˆ·ä¿¡æ¯
function updateOtherUser(username, command) {
    if (username) {
        document.getElementById('user2-avatar').textContent = username.charAt(0).toUpperCase();
        document.getElementById('user2-name').textContent = username;
        document.getElementById('other-command').value = command || '';
        document.getElementById('other-hint').textContent = 'å¯¹æ–¹å·²åŠ å…¥æˆ¿é—´';
        
        if (command) {
            document.getElementById('other-status').textContent = 'å·²è¾“å…¥';
            document.getElementById('other-status').className = 'command-status success';
        }
    }
}

// æ›´æ–°è¿æ¥çŠ¶æ€
function updateConnectionStatus(connected) {
    const dot = document.querySelector('.status-dot');
    const text = document.querySelector('.status-text');
    
    if (connected) {
        dot.classList.add('active');
        text.textContent = 'å·²è¿æ¥';
    } else {
        dot.classList.remove('active');
        text.textContent = 'ç­‰å¾…å¯¹æ–¹åŠ å…¥...';
    }
}

// åˆ†äº«æˆ¿é—´
function shareRoom() {
    const url = window.location.href;
    
    if (navigator.share) {
        navigator.share({
            title: 'åŠ å…¥æˆ‘çš„çˆ±å¿ƒåä½œæˆ¿é—´',
            text: `é‚€è¯·ä½ åŠ å…¥çˆ±å¿ƒåä½œæˆ¿é—´ ${roomCode}`,
            url: url
        });
    } else {
        navigator.clipboard.writeText(url).then(() => {
            showMessage('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
        }).catch(() => {
            prompt('å¤åˆ¶è¿™ä¸ªé“¾æ¥åˆ†äº«ç»™TAï¼š', url);
        });
    }
}

// æ˜¾ç¤ºçˆ±å¿ƒçºªå¿µå¡
function showLoveModal(data) {
    document.getElementById('loveDescription').textContent = data.description;
    document.getElementById('loveUser2').textContent = userRole === 'user1' 
        ? data.user2_username 
        : data.user1_username;
    document.getElementById('loveTime').textContent = new Date(data.timestamp).toLocaleString('zh-CN');
    
    document.getElementById('loveModal').style.display = 'block';
}

// å…³é—­çˆ±å¿ƒçºªå¿µå¡
function closeLoveModal() {
    document.getElementById('loveModal').style.display = 'none';
    document.getElementById('my-command').value = '';
    document.getElementById('other-command').value = '';
    document.getElementById('my-status').textContent = '';
    document.getElementById('other-status').textContent = '';
    lastCommand = '';
}

// åˆ›å»ºå½©å¸¦æ•ˆæœ
function createConfetti() {
    const colors = ['#ff4d4d', '#ff9933', '#ffcc00', '#33cc33', '#3399ff', '#ff66cc'];
    
    for (let i = 0; i < 100; i++) {
        setTimeout(() => {
            const confetti = document.createElement('div');
            confetti.className = 'confetti';
            confetti.style.left = Math.random() * 100 + 'vw';
            confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
            confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
            
            document.body.appendChild(confetti);
            
            setTimeout(() => confetti.remove(), 3000);
        }, i * 30);
    }
}

// æ’­æ”¾æç¤ºéŸ³
function playNotificationSound() {
    const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2teleQAA');
    audio.volume = 0.3;
    audio.play().catch(() => {});
}

// æ’­æ”¾æˆåŠŸéŸ³æ•ˆ
function playSuccessSound() {
    const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2teleQAA');
    audio.volume = 0.5;
    audio.play().catch(() => {});
}

// å…ƒç´ æŠ–åŠ¨æ•ˆæœ
function shakeElement(element) {
    element.style.animation = 'shake 0.5s';
    setTimeout(() => {
        element.style.animation = '';
    }, 500);
}

// æ˜¾ç¤ºæ¶ˆæ¯
function showMessage(message, type) {
    const messageArea = document.getElementById('messageArea');
    const messageEl = document.createElement('div');
    messageEl.className = `message message-${type}`;
    messageEl.textContent = message;
    
    messageArea.appendChild(messageEl);
    
    setTimeout(() => {
        messageEl.remove();
    }, 3000);
}

// æ·»åŠ æŠ–åŠ¨åŠ¨ç”»æ ·å¼
const style = document.createElement('style');
style.textContent = `
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-5px); }
        75% { transform: translateX(5px); }
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}
